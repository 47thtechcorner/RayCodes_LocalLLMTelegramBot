"""Indian Stock Alert Bot â€” yfinance + Ollama LLM + Telegram"""
import os, json, time, signal, logging, requests, yfinance as yf
from datetime import datetime
from dotenv import load_dotenv

load_dotenv()
TOKEN, CHAT_ID = os.getenv("TELEGRAM_BOT_TOKEN"), os.getenv("TELEGRAM_CHAT_ID")
CFG = json.load(open("config.json"))
OLLAMA, running = "http://localhost:11434/api/generate", True
logging.basicConfig(format="%(asctime)s | %(message)s", datefmt="%H:%M:%S", level=logging.INFO)
log = logging.getLogger(__name__)

def stop(s, f): global running; log.info("ğŸ›‘ Shutting down..."); running = False
signal.signal(signal.SIGINT, stop); signal.signal(signal.SIGBREAK, stop)

def fetch_stock(ticker):
    t = yf.Ticker(ticker); info = t.info
    price = info.get("currentPrice") or info.get("regularMarketPrice", 0)
    prev = info.get("previousClose") or info.get("regularMarketPreviousClose", 0)
    chg = round(((price - prev) / prev) * 100, 2) if prev else 0
    hist = t.history(period="5d")
    avg_v = int(hist["Volume"].mean()) if not hist.empty else 0
    w52h, w52l = info.get("fiftyTwoWeekHigh", 0), info.get("fiftyTwoWeekLow", 0)
    cur = "$" if "USD" in ticker.upper() else "â‚¹"
    return {"name": info.get("shortName", ticker), "price": price, "chg": chg,
            "high": info.get("dayHigh", 0), "low": info.get("dayLow", 0),
            "w52h": w52h, "w52l": w52l, "vol": info.get("volume", 0), "avg_v": avg_v, "cur": cur}

def llm_insight(d):
    c = d['cur']
    prompt = (f"Stock: {d['name']} @ {c}{d['price']}, 1D chg {d['chg']:+.2f}%, "
              f"Day H/L {c}{d['high']}/{c}{d['low']}, 52W H/L {c}{d['w52h']}/{c}{d['w52l']}, "
              f"Vol {d['vol']:,} vs 5D avg {d['avg_v']:,}. Give a 2-line trading insight. No preamble.")
    try: return requests.post(OLLAMA, json={"model": CFG["llm_model"], "prompt": prompt, "stream": False}, timeout=120).json().get("response", "N/A").strip()
    except Exception as e: return f"âš ï¸ LLM unavailable: {e}"

def format_and_send(d, insight):
    icon, c, vr = "ğŸŸ¢" if d["chg"] >= 0 else "ğŸ”´", d["cur"], round(d["vol"] / d["avg_v"], 2) if d["avg_v"] else 0
    msg = (f"ğŸ“Š *{d['name']}* â€” {datetime.now().strftime('%I:%M %p IST')}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
           f"ğŸ’° {c}{d['price']:,.2f} {icon} {d['chg']:+.2f}% | H: {c}{d['high']:,.2f} L: {c}{d['low']:,.2f}\n"
           f"ğŸ“ˆ 52W: {c}{d['w52h']:,.2f} / {c}{d['w52l']:,.2f} | {'ğŸ”¥' if vr > 1.3 else 'ğŸ“Š'} Vol: {d['vol']:,} ({vr}x avg)\n"
           f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ§  *Insight:*\n{insight}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    try: requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", json={"chat_id": CHAT_ID, "text": msg, "parse_mode": "Markdown"}, timeout=15); log.info("âœ… Sent")
    except Exception as e: log.error(f"âŒ TG failed: {e}")

if __name__ == "__main__":
    log.info("ğŸš€ Stock Bot started â€” Ctrl+C to stop")
    while running:
        for tk in CFG["stocks"]:
            if not running: break
            try: log.info(f"ğŸ“¡ {tk}..."); d = fetch_stock(tk); log.info(f"   {d['name']}={d['cur']}{d['price']:,.2f} ({d['chg']:+.2f}%)"); format_and_send(d, llm_insight(d))
            except Exception as e: log.error(f"Error [{tk}]: {e}")
        if running:
            log.info(f"ğŸ’¤ Next in {CFG['interval_seconds']}s...")
            for _ in range(CFG["interval_seconds"]):
                if not running: break
                time.sleep(1)
    log.info("ğŸ‘‹ Bot stopped.")
